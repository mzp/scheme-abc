.PHONY: clean

OCAMLPACKS[] =
     str
     extlib

UseCamlp4(pa_openin pa_oo)

FILES[] =
	module
	binding
	closureTrans
	bytes
	label
	abc
	cpool
	revList
	instruction
	asm
	codegen
	override
	main

CPPFLAGS+=-I../type

PROGRAM=../codegen

OCAMLOPT   = ocamlopt -for-pack $(capitalize $(basename $(PROGRAM)))
OCAMLOPTLINK  = ocamlopt

OCamlProgram(gen_inst,gen_inst)
OCamlLibrary(codegen, $(FILES))
OCamlPackage($(PROGRAM), $(FILES))

.DEFAULT: $(PROGRAM).cmo $(PROGRAM).cmx

match_body.h: gen_inst$(EXE) instruction.txt
    ./gen_inst$(EXE) -m < instruction.txt > $@

opcode.h: gen_inst$(EXE) instruction.txt
    ./gen_inst$(EXE) -t < instruction.txt > $@

instruction.ml : match_body.h opcode.h

clean:
	ocaml-clean opcode.h match_body.h instruction.ml gen_inst$(EXE)
